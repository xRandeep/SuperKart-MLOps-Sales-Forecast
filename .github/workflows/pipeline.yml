name: SuperKart MLOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  run-mlops-pipeline:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      HF_USERNAME: ${{ vars.HF_USERNAME }}
      DATASET_REPO_NAME: "SuperKart-data"
      MODEL_REPO_NAME: "SuperKart-model"
      SPACE_NAME: "SuperKart-sales-prediction-app" 

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Downloads full history (Fixes 'shallow update' error)
        lfs: true       # Enables Large File Storage (Fixes 'lfs-check' error)
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: "3.9"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 1. Register Data
      run: python src/register_data.py
      
    - name: 2. Process Data
      run: python src/process_data.py
      
    - name: 3. Train & Evaluate
      run: python src/train.py
      
    - name: Build Docker Image (Test Build)
      run: docker build -t superkart-app .
      
    - name: Push to Hugging Face Spaces
      run: |
        # --- CLEANUP STEP ---
        # 1. Remove the generated binary model (train.py already uploads it to Model Hub)
        rm -f model.joblib
        rm -f artifacts/model.joblib

        # 2. Remove Jupyter Notebooks so they don't upload to Space
        find . -name "*.ipynb" -type f -delete

        # --- FRESH START PUSH ---
        # 3. DELETE THE .GIT FOLDER (Wipes out "poisoned" history)
        rm -rf .git
        
        # 4. Initialize a brand new Git repository
        git init
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # 5. Add all currently existing files (Clean versions only)
        git add .
        
        # 6. Commit 
        git commit -m "Deploy app (Fresh Start - Clean History)"
        
        # 7. Add Remote and Force Push (Restored this logic)
        git remote add space https://oauth2:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME
        git push --force space main:main